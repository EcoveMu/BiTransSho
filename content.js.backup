// å…§å®¹è…³æœ¬ - å¢å¼·ç‰ˆèªéŸ³è­˜åˆ¥å’Œå­—å¹•é¡¯ç¤ºç³»çµ±

class SpeechTranslationApp {
  constructor() {
    this.isRecording = false;
    this.recognition = null;
    this.subtitleContainer = null;
    this.settings = {
      targetLanguages: ['zh-tw', 'en'],
      translationProvider: 'free'
    };
    
    // å¢å¼·åŠŸèƒ½ï¼šå®Œæ•´è¨˜éŒ„ç³»çµ±
    this.sessionHistory = {
      sessionId: this.generateSessionId(),
      startTime: new Date(),
      records: [],
      totalDuration: 0
    };
    
    // ç•Œé¢ç‹€æ…‹ç®¡ç†
    this.currentView = 'live'; // live, history, translation
    this.subtitlePanels = {};
    
    this.initialize();
  }
  
  generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  async initialize() {
    console.log('ğŸš€ åˆå§‹åŒ–å¢å¼·ç‰ˆèªéŸ³ç¿»è­¯æ‡‰ç”¨...');
    
    // è¼‰å…¥è¨­å®š
    await this.loadSettings();
    
    // å‰µå»ºå¢å¼·ç‰ˆå­—å¹•å®¹å™¨
    this.createEnhancedSubtitleContainer();
    
    // åˆå§‹åŒ–èªéŸ³è­˜åˆ¥
    this.initializeSpeechRecognition();
    
    console.log('âœ… å¢å¼·ç‰ˆèªéŸ³ç¿»è­¯æ‡‰ç”¨åˆå§‹åŒ–å®Œæˆ');
  }

  async loadSettings() {
    try {
      // ä½¿ç”¨çµ±ä¸€çš„è¨­å®šç³»çµ±ï¼Œèˆ‡subtitle-window.jsä¿æŒä¸€è‡´
      const result = await chrome.storage.sync.get([
        'translationProvider', 'translationApiKey', 'speechRecognitionLanguage', 
        'speechRecognitionEngine', 'audioInputDevice', 'targetLanguages',
        'microsoftApiKey', 'openaiApiKey', 'microsoftKey', 'openaiKey'
      ]);
      
      console.log('ğŸ”§ content.jsè¼‰å…¥çš„è¨­å®š:', result);
      
      // è¨­å®šé·ç§»é‚è¼¯ - å„ªå…ˆä½¿ç”¨æ–°ç‰ˆè¨­å®šï¼Œå›é€€åˆ°èˆŠç‰ˆ
      this.settings.translationProvider = result.translationProvider || 'free';
      this.settings.targetLanguages = result.targetLanguages || ['zh-tw', 'en'];
      this.settings.speechRecognitionLanguage = result.speechRecognitionLanguage || 'zh-TW';
      this.settings.microsoftApiKey = result.microsoftApiKey || result.microsoftKey || '';
      this.settings.openaiApiKey = result.openaiApiKey || result.openaiKey || '';
      
      console.log('âœ… content.jsè¨­å®šè¼‰å…¥æˆåŠŸ:', this.settings);
    } catch (error) {
      console.error('âŒ content.jsè¨­å®šè¼‰å…¥å¤±æ•—:', error);
    }
  }

  createEnhancedSubtitleContainer() {
    // ç§»é™¤èˆŠçš„å®¹å™¨
    const existingContainer = document.getElementById('speech-translation-subtitles');
    if (existingContainer) {
      existingContainer.remove();
    }

    // å‰µå»ºä¸»å®¹å™¨
    this.subtitleContainer = document.createElement('div');
    this.subtitleContainer.id = 'speech-translation-subtitles';
    this.subtitleContainer.className = 'enhanced-subtitles-container';
    
    // å‰µå»ºæ¨™é¡Œæ¬„
    const titleBar = document.createElement('div');
    titleBar.className = 'subtitle-title-bar';
    titleBar.innerHTML = `
      <div class="title-left">
        <div class="drag-handle">â‹®â‹®</div>
        <span class="title-text">ğŸ¤ ç¶²é å³æ™‚å­—å¹•</span>
      </div>
      <div class="title-controls">
        <button class="view-btn ${this.currentView === 'live' ? 'active' : ''}" data-view="live">ğŸ“º å³æ™‚</button>
        <button class="view-btn ${this.currentView === 'history' ? 'active' : ''}" data-view="history">ğŸ“š è¨˜éŒ„</button>
        <button class="view-btn ${this.currentView === 'translation' ? 'active' : ''}" data-view="translation">ğŸŒ ç¿»è­¯</button>
        <button class="minimize-btn">â”€</button>
        <button class="close-btn">Ã—</button>
      </div>
    `;
    
    // å‰µå»ºå…§å®¹å€åŸŸ
    const contentArea = document.createElement('div');
    contentArea.className = 'subtitle-content-area';
    
    // å‰µå»ºå³æ™‚å­—å¹•é¢æ¿
    this.createLivePanel(contentArea);
    
    // å‰µå»ºæ­·å²è¨˜éŒ„é¢æ¿
    this.createHistoryPanel(contentArea);
    
    // å‰µå»ºç¿»è­¯é¢æ¿
    this.createTranslationPanel(contentArea);
    
    // å‰µå»ºç‹€æ…‹æ¬„
    const statusBar = document.createElement('div');
    statusBar.className = 'subtitle-status-bar';
    statusBar.innerHTML = `
      <div class="status-left">
        <span class="recording-status">â¸ï¸ å¾…æ©Ÿä¸­</span>
        <span class="session-info">æœƒè©±ï¼š${this.sessionHistory.sessionId.slice(-8)}</span>
      </div>
      <div class="status-right">
        <span class="record-count">è¨˜éŒ„ï¼š0</span>
        <span class="language-info">èªè¨€ï¼šè‡ªå‹•</span>
      </div>
    `;
    
    // çµ„è£å®¹å™¨
    this.subtitleContainer.appendChild(titleBar);
    this.subtitleContainer.appendChild(contentArea);
    this.subtitleContainer.appendChild(statusBar);
    
    // è¨­ç½®äº‹ä»¶ç›£è½å™¨
    this.setupEnhancedEventListeners();
    
    // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
    this.makeDraggable(this.subtitleContainer, titleBar.querySelector('.drag-handle'));
    
    // åˆå§‹éš±è—
    this.subtitleContainer.style.display = 'none';
    
    document.body.appendChild(this.subtitleContainer);
  }

  makeDraggable(element, handle) {
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;

    handle.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);

    function dragStart(e) {
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;
      
      if (e.target === handle) {
        isDragging = true;
        handle.style.cursor = 'grabbing';
      }
    }

    function drag(e) {
      if (isDragging) {
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        xOffset = currentX;
        yOffset = currentY;
        
        element.style.transform = `translate(${currentX}px, ${currentY}px)`;
      }
    }

    function dragEnd() {
      initialX = currentX;
      initialY = currentY;
      isDragging = false;
      handle.style.cursor = 'grab';
    }
  }

  initializeSpeechRecognition() {
    // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      console.error('ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è­˜åˆ¥');
      this.showMessage('ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è­˜åˆ¥åŠŸèƒ½', 'error');
      return false;
    }

    try {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      this.recognition = new SpeechRecognition();
      
      // è¨­å®šèªéŸ³è­˜åˆ¥åƒæ•¸
      this.recognition.continuous = true;
      this.recognition.interimResults = true;
      this.recognition.maxAlternatives = 1;
      
      // ä½¿ç”¨çµ±ä¸€è¨­å®šçš„èªè¨€
      const language = this.settings.speechRecognitionLanguage || 'zh-TW';
      this.recognition.lang = language;
      console.log('ğŸ—£ï¸ content.jsèªéŸ³è­˜åˆ¥èªè¨€è¨­å®šç‚º:', language);
      
      // è™•ç†è­˜åˆ¥çµæœ
      this.recognition.onresult = (event) => {
        if (!this.isRecording) return;
        this.handleRecognitionResult(event);
      };

      // è™•ç†éŒ¯èª¤
      this.recognition.onerror = (event) => {
        console.error('èªéŸ³è­˜åˆ¥éŒ¯èª¤:', event.error);
        this.handleRecognitionError(event);
      };

      // è­˜åˆ¥çµæŸè™•ç†
      this.recognition.onend = () => {
        console.log('èªéŸ³è­˜åˆ¥çµæŸ');
        if (this.isRecording) {
          // å¦‚æœé‚„åœ¨éŒ„éŸ³ç‹€æ…‹ï¼Œé‡æ–°å•Ÿå‹•
          setTimeout(() => {
            if (this.isRecording && this.recognition) {
              try {
                this.recognition.start();
              } catch (error) {
                console.error('é‡æ–°å•Ÿå‹•è­˜åˆ¥å¤±æ•—:', error);
              }
            }
          }, 1000);
        }
      };

      this.recognition.onstart = () => {
        console.log('èªéŸ³è­˜åˆ¥å·²å•Ÿå‹•');
        this.showMessage('ğŸ¤ é–‹å§‹è½å–èªéŸ³...', 'success');
      };

      return true;
    } catch (error) {
      console.error('åˆå§‹åŒ–èªéŸ³è­˜åˆ¥å¤±æ•—:', error);
      this.showMessage(`åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
      return false;
    }
  }

  handleRecognitionResult(event) {
    let finalTranscript = '';
    let interimTranscript = '';

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const result = event.results[i];
      const transcript = result[0].transcript;

      if (result.isFinal) {
        finalTranscript += transcript;
      } else {
        interimTranscript += transcript;
      }
    }

    // é¡¯ç¤ºå³æ™‚è­˜åˆ¥çµæœ
    if (interimTranscript) {
      this.showInterimSubtitle(interimTranscript);
    }

    // è™•ç†æœ€çµ‚çµæœ
    if (finalTranscript) {
      console.log('æœ€çµ‚è­˜åˆ¥çµæœ:', finalTranscript);
      this.processRecognizedText(finalTranscript);
    }
  }

  handleRecognitionError(event) {
    console.error('èªéŸ³è­˜åˆ¥éŒ¯èª¤:', event.error);
    
    switch (event.error) {
      case 'not-allowed':
        this.showMessage('éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•', 'error');
        this.isRecording = false;
        break;
      case 'no-speech':
        // éœéŸ³ä¸é¡¯ç¤ºéŒ¯èª¤
        break;
      case 'network':
        this.showMessage('ç¶²è·¯éŒ¯èª¤', 'error');
        break;
      default:
        this.showMessage(`èªéŸ³è­˜åˆ¥éŒ¯èª¤: ${event.error}`, 'error');
    }
  }

  async processRecognizedText(text) {
    if (!text || text.trim().length === 0) return;
    
    try {
      console.log('ğŸ¯ è™•ç†è­˜åˆ¥æ–‡æœ¬:', text);
      
      // å‰µå»ºè¨˜éŒ„æ¢ç›®
      const recordEntry = this.createRecordEntry(text);
      
      // é¡¯ç¤ºåœ¨å³æ™‚é¢æ¿
      this.displayInLivePanel(recordEntry);
      
      // æ·»åŠ åˆ°æ­·å²è¨˜éŒ„
      this.addToHistory(recordEntry);
      
      // æ›´æ–°ç‹€æ…‹æ¬„
      this.updateStatusBar();
      
      // ç™¼é€ç¿»è­¯è«‹æ±‚
      const response = await chrome.runtime.sendMessage({
        action: 'translate',
        text: text,
        targetLanguages: this.settings.targetLanguages || ['zh-tw', 'en']
      });

      if (response && response.success) {
        // æ›´æ–°è¨˜éŒ„æ¢ç›®çš„ç¿»è­¯
        recordEntry.translations = response.data.translations;
        recordEntry.translationStatus = 'completed';
        
        // æ›´æ–°å³æ™‚é¢æ¿çš„ç¿»è­¯
        this.updateLivePanelTranslation(recordEntry.id, response.data);
        
        // æ›´æ–°ç¿»è­¯é¢æ¿
        this.updateTranslationPanel(recordEntry);
        
        console.log('âœ… ç¿»è­¯è™•ç†å®Œæˆ:', response.data);
      } else {
        console.error('âŒ ç¿»è­¯å¤±æ•—:', response?.error);
        recordEntry.translationStatus = 'failed';
        recordEntry.translationError = response?.error || 'æœªçŸ¥éŒ¯èª¤';
        this.showMessage(`ç¿»è­¯å¤±æ•—: ${response?.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
      }
    } catch (error) {
      console.error('âŒ è™•ç†æ–‡æœ¬å¤±æ•—:', error);
      this.showMessage(`è™•ç†å¤±æ•—: ${error.message}`, 'error');
    }
  }

  createRecordEntry(text) {
    const recordEntry = {
      id: 'record_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      timestamp: new Date(),
      originalText: text,
      translations: [],
      translationStatus: 'pending', // pending, completed, failed
      translationError: null,
      confidence: 0.8, // é è¨­ä¿¡å¿ƒåº¦
      speakerInfo: {
        speaker: `è¬›è€… ${this.sessionHistory.records.length + 1}`,
        isNewSpeaker: true
      }
    };
    
    return recordEntry;
  }

  displayInLivePanel(recordEntry) {
    const liveContent = document.getElementById('liveContent');
    if (!liveContent) return;
    
    // éš±è— no-content æç¤º
    const noContent = liveContent.querySelector('.no-content');
    if (noContent) {
      noContent.style.display = 'none';
    }
    
    // å‰µå»ºå³æ™‚å­—å¹•é …ç›®
    const liveItem = document.createElement('div');
    liveItem.className = 'live-subtitle-item';
    liveItem.id = `live_${recordEntry.id}`;
    liveItem.innerHTML = `
      <div class="live-item-header">
        <span class="timestamp">${recordEntry.timestamp.toLocaleTimeString()}</span>
        <span class="speaker">${recordEntry.speakerInfo.speaker}</span>
        <span class="translation-status loading">ğŸ”„ ç¿»è­¯ä¸­...</span>
      </div>
      <div class="original-text">${recordEntry.originalText}</div>
      <div class="translation-area" id="translation_${recordEntry.id}">
        <div class="loading-indicator">æ­£åœ¨ç¿»è­¯...</div>
      </div>
    `;
    
    liveContent.appendChild(liveItem);
    
    // è‡ªå‹•æ»¾å‹•åˆ°æœ€æ–°å…§å®¹
    liveContent.scrollTop = liveContent.scrollHeight;
    
    // é¡¯ç¤ºå®¹å™¨
    this.subtitleContainer.style.display = 'block';
  }

  updateLivePanelTranslation(recordId, translationData) {
    const translationArea = document.getElementById(`translation_${recordId}`);
    const statusElement = document.querySelector(`#live_${recordId} .translation-status`);
    
    if (!translationArea) return;
    
    // æ›´æ–°ç‹€æ…‹
    if (statusElement) {
      statusElement.className = 'translation-status completed';
      statusElement.textContent = 'âœ… å®Œæˆ';
    }
    
    // æ¸…ç©ºåŠ è¼‰æŒ‡ç¤ºå™¨
    translationArea.innerHTML = '';
    
    // é¡¯ç¤ºç¿»è­¯çµæœ
    if (translationData.translations && Array.isArray(translationData.translations)) {
      translationData.translations.forEach(translation => {
        if (translation.text !== translationData.original) {
          const translationElement = document.createElement('div');
          translationElement.className = 'translation-item';
          translationElement.innerHTML = `
            <span class="lang-label">${this.getLanguageName(translation.language)}:</span>
            <span class="translation-text">${translation.text}</span>
          `;
          translationArea.appendChild(translationElement);
        }
      });
    }
  }

  addToHistory(recordEntry) {
    // æ·»åŠ åˆ°æœƒè©±æ­·å²
    this.sessionHistory.records.push(recordEntry);
    
    // æ›´æ–°æ­·å²é¢æ¿
    this.updateHistoryPanel();
  }

  updateHistoryPanel() {
    const historyContent = document.getElementById('historyContent');
    if (!historyContent) return;
    
    // æ¸…ç©ºç¾æœ‰å…§å®¹
    historyContent.innerHTML = '';
    
    if (this.sessionHistory.records.length === 0) {
      historyContent.innerHTML = '<div class="no-content">å°šç„¡æœƒè©±è¨˜éŒ„</div>';
      return;
    }
    
    // é¡¯ç¤ºæ‰€æœ‰è¨˜éŒ„
    this.sessionHistory.records.forEach(record => {
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item';
      historyItem.innerHTML = `
        <div class="history-header">
          <span class="timestamp">${record.timestamp.toLocaleTimeString()}</span>
          <span class="speaker">${record.speakerInfo.speaker}</span>
          <span class="record-id">#${record.id.slice(-6)}</span>
        </div>
        <div class="original-text">${record.originalText}</div>
        <div class="translations">
          ${this.renderTranslations(record.translations)}
        </div>
      `;
      historyContent.appendChild(historyItem);
    });
  }

  updateTranslationPanel(recordEntry) {
    const translationContent = document.getElementById('translationContent');
    if (!translationContent) return;
    
    // éš±è— no-content æç¤º
    const noContent = translationContent.querySelector('.no-content');
    if (noContent) {
      noContent.style.display = 'none';
    }
    
    // å‰µå»ºç¿»è­¯é …ç›®
    const translationItem = document.createElement('div');
    translationItem.className = 'translation-entry';
    translationItem.innerHTML = `
      <div class="translation-header">
        <span class="timestamp">${recordEntry.timestamp.toLocaleTimeString()}</span>
        <span class="original-preview">${recordEntry.originalText.substring(0, 50)}${recordEntry.originalText.length > 50 ? '...' : ''}</span>
      </div>
      <div class="translation-results">
        ${this.renderTranslations(recordEntry.translations)}
      </div>
    `;
    
    translationContent.appendChild(translationItem);
    
    // è‡ªå‹•æ»¾å‹•
    translationContent.scrollTop = translationContent.scrollHeight;
  }

  renderTranslations(translations) {
    if (!translations || !Array.isArray(translations)) {
      return '<div class="no-translation">ç„¡ç¿»è­¯çµæœ</div>';
    }
    
    return translations.map(translation => `
      <div class="translation-result">
        <span class="lang-label">${this.getLanguageName(translation.language)}</span>
        <span class="translation-text">${translation.text}</span>
      </div>
    `).join('');
  }

  showInterimSubtitle(text) {
    if (!this.subtitleContainer || !this.subtitleContent) return;
    
    // é¡¯ç¤ºå®¹å™¨
    this.subtitleContainer.style.display = 'block';
    
    // å‰µå»ºæˆ–æ›´æ–°è‡¨æ™‚å­—å¹•
    let interimElement = this.subtitleContent.querySelector('.interim-subtitle');
    if (!interimElement) {
      interimElement = document.createElement('div');
      interimElement.className = 'interim-subtitle';
      this.subtitleContent.appendChild(interimElement);
    }
    
    interimElement.innerHTML = `<span class="interim-label">è­˜åˆ¥ä¸­...</span>${text}`;
    
    // è‡ªå‹•æ»¾å‹•
    this.subtitleContent.scrollTop = this.subtitleContent.scrollHeight;
  }

  displaySubtitles(translationData) {
    if (!this.subtitleContainer || !this.subtitleContent) return;
    
    // æ¸…é™¤è‡¨æ™‚å­—å¹•
    const interimElement = this.subtitleContent.querySelector('.interim-subtitle');
    if (interimElement) {
      interimElement.remove();
    }

    // å‰µå»ºå­—å¹•çµ„å…ƒç´ 
    const subtitleGroup = document.createElement('div');
    subtitleGroup.className = 'subtitle-group';
    
    // æ·»åŠ æ™‚é–“æˆ³
    const timestamp = document.createElement('div');
    timestamp.className = 'timestamp';
    timestamp.textContent = new Date().toLocaleTimeString();
    subtitleGroup.appendChild(timestamp);

    // é¡¯ç¤ºåŸæ–‡
    const originalElement = document.createElement('div');
    originalElement.className = 'original-text';
    originalElement.textContent = translationData.original;
    subtitleGroup.appendChild(originalElement);

    // é¡¯ç¤ºç¿»è­¯
    if (translationData.translations && Array.isArray(translationData.translations)) {
      translationData.translations.forEach(translation => {
        if (translation.text !== translationData.original) {
          const translationElement = document.createElement('div');
          translationElement.className = 'translation-text';
          translationElement.innerHTML = `
            <span class="lang-label">${this.getLanguageName(translation.language)}:</span>
            ${translation.text}
          `;
          subtitleGroup.appendChild(translationElement);
        }
      });
    }

    // æ·»åŠ åˆ†éš”ç·š
    const separator = document.createElement('div');
    separator.className = 'subtitle-separator';
    subtitleGroup.appendChild(separator);

    // æ·»åŠ åˆ°å®¹å™¨
    this.subtitleContent.appendChild(subtitleGroup);

    // é¡¯ç¤ºå®¹å™¨
    this.subtitleContainer.style.display = 'block';

    // è‡ªå‹•æ»¾å‹•åˆ°æœ€æ–°å­—å¹•
    this.subtitleContent.scrollTop = this.subtitleContent.scrollHeight;

    // é™åˆ¶å­—å¹•æ•¸é‡
    const subtitleGroups = this.subtitleContent.querySelectorAll('.subtitle-group');
    while (subtitleGroups.length > 10) {
      subtitleGroups[0].remove();
    }
  }

  getLanguageName(langCode) {
    const languageNames = {
      'zh-tw': 'ä¸­æ–‡',
      'zh': 'ä¸­æ–‡',
      'en': 'English',
      'ja': 'æ—¥æœ¬èª',
      'ko': 'í•œêµ­ì–´',
      'fr': 'FranÃ§ais',
      'de': 'Deutsch',
      'es': 'EspaÃ±ol'
    };
    return languageNames[langCode] || langCode.toUpperCase();
  }

  showMessage(message, type = 'info') {
    console.log(`ç‹€æ…‹æ¶ˆæ¯: ${message} (${type})`);
    
    if (this.subtitleContainer) {
      const messageElement = document.createElement('div');
      messageElement.className = `message ${type}`;
      messageElement.textContent = message;
      this.subtitleContainer.appendChild(messageElement);
      
      setTimeout(() => {
        if (messageElement.parentNode) {
          messageElement.remove();
        }
      }, 3000);
    }
  }

  async startRecording() {
    console.log('ğŸ¤ é–‹å§‹éŒ„éŸ³...');
    
    // Teamsç’°å¢ƒæª¢æ¸¬å’Œè¨ºæ–·
    const isTeamsEnvironment = this.detectTeamsEnvironment();
    if (isTeamsEnvironment) {
      console.log('ğŸŸ¡ æª¢æ¸¬åˆ°Teamsç’°å¢ƒï¼Œé–‹å•Ÿå¢å¼·æ¨¡å¼');
      this.showMessage('ğŸŸ¡ Teamsç’°å¢ƒæª¢æ¸¬åˆ°ï¼Œæ­£åœ¨å•Ÿå‹•å¢å¼·æ¨¡å¼...', 'info');
    }
    
    // è©³ç´°çš„ç’°å¢ƒè¨ºæ–·
    await this.performAudioDiagnostic();
    
    if (!this.recognition) {
      const initialized = this.initializeSpeechRecognition();
      if (!initialized) {
        this.showMessage('âŒ èªéŸ³è­˜åˆ¥åˆå§‹åŒ–å¤±æ•—', 'error');
        return false;
      }
    }

    try {
      // é‡å°Teamsçš„ç‰¹æ®Šè™•ç†
      if (isTeamsEnvironment) {
        await this.handleTeamsAudioSetup();
      }
      
      // è«‹æ±‚éº¥å…‹é¢¨æ¬Šé™
      const stream = await navigator.mediaDevices.getUserMedia({ 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true,
          sampleRate: 16000
        }
      });
      
      console.log('âœ… éŸ³é »æ¬Šé™ç²å–æˆåŠŸ');
      
      this.isRecording = true;
      this.recognition.start();
      
      this.showMessage('ğŸ¤ èªéŸ³è­˜åˆ¥å·²å•Ÿå‹• - è«‹é–‹å§‹èªªè©±', 'success');
      
      // é¡¯ç¤ºå­—å¹•å®¹å™¨
      if (this.subtitleContainer) {
        this.subtitleContainer.style.display = 'block';
      }
      
      // Teamsç’°å¢ƒçš„ç‰¹æ®Šæç¤º
      if (isTeamsEnvironment) {
        setTimeout(() => {
          this.showMessage('ğŸ’¡ Teamsç’°å¢ƒï¼šè«‹ç¢ºä¿æ‚¨æœ‰åœ¨èªªè©±æˆ–Teamsæœ‰è²éŸ³è¼¸å‡º', 'info');
        }, 2000);
      }
      
      return true;
    } catch (error) {
      console.error('âŒ å•Ÿå‹•èªéŸ³è­˜åˆ¥å¤±æ•—:', error);
      
      // è©³ç´°çš„éŒ¯èª¤åˆ†æ
      const errorAnalysis = this.analyzeAudioError(error);
      this.showMessage(`âŒ å•Ÿå‹•å¤±æ•—: ${errorAnalysis}`, 'error');
      
      // Teamsç‰¹æ®ŠéŒ¯èª¤è™•ç†
      if (isTeamsEnvironment) {
        this.showTeamsSpecificGuidance(error);
      }
      
      this.isRecording = false;
      return false;
    }
  }

  // æª¢æ¸¬æ˜¯å¦åœ¨Teamsç’°å¢ƒ
  detectTeamsEnvironment() {
    const url = window.location.href;
    const userAgent = navigator.userAgent;
    
    const isTeams = url.includes('teams.microsoft.com') || 
                   url.includes('teams.live.com') ||
                   document.title.includes('Teams') ||
                   document.querySelector('[data-app-name*="teams"]') !== null;
    
    console.log('ğŸ” ç’°å¢ƒæª¢æ¸¬:', {
      url: url,
      isTeams: isTeams,
      title: document.title
    });
    
    return isTeams;
  }

  // éŸ³é »è¨ºæ–· - å¢å¼·ç‰ˆï¼Œå°ˆé–€é‡å°Teamsç’°å¢ƒ
  async performAudioDiagnostic() {
    console.log('ğŸ”§ é–‹å§‹éŸ³é »ç’°å¢ƒè¨ºæ–·...');
    
    try {
      // æª¢æŸ¥ç•¶å‰URLå’Œç’°å¢ƒ
      const isTeams = this.detectTeamsEnvironment();
      console.log('ğŸ¢ Teamsç’°å¢ƒ:', isTeams);
      
      // æª¢æŸ¥éŸ³é »è¨­å‚™
      const devices = await navigator.mediaDevices.enumerateDevices();
      const audioInputs = devices.filter(device => device.kind === 'audioinput');
      
      console.log('ğŸ¤ å¯ç”¨éŸ³é »è¨­å‚™:', audioInputs.map(d => ({
        label: d.label || 'é è¨­è¨­å‚™',
        deviceId: d.deviceId,
        groupId: d.groupId
      })));
      
      // Teamsç’°å¢ƒç‰¹æ®Šæª¢æŸ¥
      if (isTeams) {
        // æª¢æŸ¥Teamsæ˜¯å¦æ­£åœ¨ä½¿ç”¨éŸ³é »
        const teamsAudioElements = document.querySelectorAll('audio[autoplay], video[autoplay]');
        console.log('ğŸ“¹ TeamséŸ³é »/è¦–é »å…ƒç´ :', teamsAudioElements.length);
        
        // æª¢æŸ¥Teamsæœƒè­°ç‹€æ…‹
        const meetingIndicators = document.querySelectorAll('[data-tid*="call"], [aria-label*="æœƒè­°"], [aria-label*="é€šè©±"]');
        console.log('ğŸ“ Teamsæœƒè­°ç‹€æ…‹æŒ‡æ¨™:', meetingIndicators.length);
        
        if (meetingIndicators.length > 0) {
          this.showMessage('ğŸ” æª¢æ¸¬åˆ°Teamsæœƒè­°é€²è¡Œä¸­ï¼Œå¯èƒ½å½±éŸ¿éº¥å…‹é¢¨å­˜å–', 'warning');
        }
      }
      
      // æª¢æŸ¥ç€è¦½å™¨éŸ³é »æ¬Šé™ç‹€æ…‹
      if (navigator.permissions) {
        try {
          const micPermission = await navigator.permissions.query({ name: 'microphone' });
          console.log('ğŸ” éº¥å…‹é¢¨æ¬Šé™ç‹€æ…‹:', micPermission.state);
          
          if (micPermission.state === 'denied') {
            this.showMessage('âŒ éº¥å…‹é¢¨æ¬Šé™è¢«æ°¸ä¹…æ‹’çµ•ï¼Œè«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­é‡æ–°å…è¨±', 'error');
          } else if (micPermission.state === 'prompt') {
            this.showMessage('ğŸ”” éœ€è¦éº¥å…‹é¢¨æ¬Šé™ç¢ºèª', 'info');
          }
        } catch (permError) {
          console.warn('âš ï¸ ç„¡æ³•æª¢æŸ¥æ¬Šé™ç‹€æ…‹:', permError);
        }
      }
      
      // æª¢æŸ¥é é¢éŸ³é »ç‹€æ…‹
      const audioElements = document.querySelectorAll('audio, video');
      console.log('ğŸ”Š é é¢éŸ³é »å…ƒç´ :', audioElements.length);
      
      // æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ‡‰ç”¨å¯èƒ½ä½”ç”¨éŸ³é »
      try {
        const testStream = await navigator.mediaDevices.getUserMedia({ 
          audio: { sampleRate: 8000 } // ä½¿ç”¨è¼ƒä½è¦æ±‚æ¸¬è©¦
        });
        console.log('âœ… åŸºæœ¬éº¥å…‹é¢¨å­˜å–æ¸¬è©¦æˆåŠŸ');
        testStream.getTracks().forEach(track => track.stop());
      } catch (testError) {
        console.error('âŒ åŸºæœ¬éº¥å…‹é¢¨å­˜å–æ¸¬è©¦å¤±æ•—:', testError.name, testError.message);
        
        if (isTeams && testError.name === 'NotReadableError') {
          this.showMessage('âš ï¸ éº¥å…‹é¢¨è¢«Teamsä½”ç”¨ï¼Œå»ºè­°é€€å‡ºæœƒè­°å¾Œå†å•Ÿå‹•å­—å¹•', 'warning');
        }
      }
      
      // æª¢æŸ¥éŸ³é »contextç‹€æ…‹
      if (window.AudioContext || window.webkitAudioContext) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const testContext = new AudioContext();
        console.log('ğŸµ éŸ³é »Contextç‹€æ…‹:', testContext.state);
        
        if (testContext.state === 'suspended') {
          console.log('ğŸ”„ éŸ³é »Contextè¢«æš«åœï¼Œå˜—è©¦å–šé†’');
          await testContext.resume();
        }
        
        testContext.close();
      }
      
      // Teamsç’°å¢ƒå»ºè­°
      if (isTeams) {
        setTimeout(() => {
          this.showMessage('ğŸ’¡ Teamsç’°å¢ƒå»ºè­°ï¼šåœ¨åŠ å…¥æœƒè­°å‰å…ˆå•Ÿå‹•å­—å¹•ï¼Œæˆ–ä½¿ç”¨ç¨ç«‹å­—å¹•è¦–çª—', 'info');
        }, 2000);
      }
      
    } catch (error) {
      console.warn('âš ï¸ éŸ³é »è¨ºæ–·éƒ¨åˆ†å¤±æ•—:', error);
      this.showMessage('âš ï¸ éŸ³é »ç’°å¢ƒè¨ºæ–·ç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°', 'warning');
    }
  }

  // TeamséŸ³é »è¨­ç½®è™•ç†
  async handleTeamsAudioSetup() {
    console.log('ğŸŸ¡ è™•ç†TeamséŸ³é »è¨­ç½®...');
    
    // ç­‰å¾…Teamsé é¢ç©©å®š
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // æª¢æŸ¥Teamsæ˜¯å¦åœ¨é€šè©±ä¸­
    const isInCall = document.querySelector('[data-tid="call-roster"]') !== null ||
                    document.querySelector('[aria-label*="æœƒè­°"]') !== null ||
                    document.querySelector('[aria-label*="é€šè©±"]') !== null;
    
    if (isInCall) {
      console.log('ğŸ“ æª¢æ¸¬åˆ°Teamsé€šè©±é€²è¡Œä¸­');
      this.showMessage('ğŸ“ æª¢æ¸¬åˆ°Teamsé€šè©±ï¼Œæ­£åœ¨å„ªåŒ–éŸ³é »è¨­å®š...', 'info');
    }
  }

  // éŒ¯èª¤åˆ†æ
  analyzeAudioError(error) {
    const errorMessages = {
      'NotAllowedError': 'éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•ã€‚è«‹é»æ“Šç¶²å€åˆ—çš„éº¥å…‹é¢¨åœ–æ¨™å…è¨±æ¬Šé™ã€‚',
      'NotFoundError': 'æ‰¾ä¸åˆ°éº¥å…‹é¢¨è¨­å‚™ã€‚è«‹æª¢æŸ¥æ‚¨çš„éŸ³é »è¨­å‚™é€£æ¥ã€‚',
      'NotReadableError': 'éº¥å…‹é¢¨è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼å ç”¨ã€‚è«‹é—œé–‰å…¶ä»–ä½¿ç”¨éº¥å…‹é¢¨çš„ç¨‹å¼ã€‚',
      'OverconstrainedError': 'éŸ³é »è¨­å®šé™åˆ¶éåš´ã€‚å°‡ä½¿ç”¨é è¨­è¨­å®šé‡è©¦ã€‚',
      'SecurityError': 'å®‰å…¨é™åˆ¶é˜»æ­¢äº†éº¥å…‹é¢¨è¨ªå•ã€‚',
      'AbortError': 'éŸ³é »è«‹æ±‚è¢«ä¸­æ­¢ã€‚'
    };
    
    return errorMessages[error.name] || `æœªçŸ¥éŒ¯èª¤: ${error.message}`;
  }

  // Teamsç‰¹æ®ŠæŒ‡å° - å¢å¼·ç‰ˆ
  showTeamsSpecificGuidance(error) {
    setTimeout(() => {
      let guidance = '';
      let actions = [];
      
      if (error.name === 'NotAllowedError') {
        guidance = 'ğŸ”§ Teamséº¥å…‹é¢¨æ¬Šé™è§£æ±ºæ–¹æ¡ˆï¼š';
        actions = [
          '1. é»æ“Šç¶²å€åˆ—å·¦å´çš„ ğŸ”’ é–é ­åœ–æ¨™',
          '2. åœ¨å½ˆå‡ºé¸å–®ä¸­æ‰¾åˆ°ã€Œéº¥å…‹é¢¨ã€é¸é …',
          '3. é¸æ“‡ã€Œå…è¨±ã€æˆ–ã€Œè©¢å•ã€',
          '4. é‡æ–°è¼‰å…¥é é¢ (Ctrl+F5)',
          '5. é‡æ–°å•Ÿå‹•å­—å¹•åŠŸèƒ½',
          'ğŸ’¡ å¦‚æœä»æœ‰å•é¡Œï¼Œè«‹å˜—è©¦ä½¿ç”¨ç¨ç«‹å­—å¹•è¦–çª—'
        ];
      } else if (error.name === 'NotReadableError') {
        guidance = 'ğŸ”§ TeamséŸ³é »è¨­å‚™è¡çªè§£æ±ºï¼š';
        actions = [
          '1. æš«æ™‚é€€å‡ºTeamsæœƒè­°ï¼ˆä¿æŒTeamsé é¢é–‹å•Ÿï¼‰',
          '2. é‡æ–°è¼‰å…¥Teamsé é¢ (F5)',
          '3. å•Ÿå‹•å­—å¹•åŠŸèƒ½ä¸¦æ¸¬è©¦éº¥å…‹é¢¨',
          '4. ç¢ºèªå­—å¹•æ­£å¸¸å·¥ä½œå¾Œï¼Œé‡æ–°åŠ å…¥æœƒè­°',
          'âš ï¸ æˆ–è€…ä½¿ç”¨ç¨ç«‹å­—å¹•è¦–çª—é¿å…è¡çª'
        ];
      } else if (error.name === 'NotFoundError') {
        guidance = 'ğŸ”§ TeamséŸ³é »è¨­å‚™å•é¡Œï¼š';
        actions = [
          '1. æª¢æŸ¥éº¥å…‹é¢¨æ˜¯å¦æ­£ç¢ºé€£æ¥',
          '2. åœ¨Teamsè¨­å®šä¸­æ¸¬è©¦éº¥å…‹é¢¨',
          '3. å˜—è©¦é‡æ–°æ’æ‹”éº¥å…‹é¢¨è¨­å‚™',
          '4. æª¢æŸ¥WindowséŸ³é »è¨­å®š',
          '5. é‡æ–°å•Ÿå‹•ç€è¦½å™¨'
        ];
      } else {
        guidance = 'ğŸ”§ Teamsç’°å¢ƒä¸€èˆ¬è§£æ±ºæ–¹æ¡ˆï¼š';
        actions = [
          '1. åˆ·æ–°é é¢ä¸¦é‡æ–°å˜—è©¦ (Ctrl+F5)',
          '2. æª¢æŸ¥Teamsæ˜¯å¦æœ‰è²éŸ³è¼¸å‡º',
          '3. å˜—è©¦ä½¿ç”¨ç¨ç«‹å­—å¹•è¦–çª—æ¨¡å¼',
          '4. ç¢ºä¿æ²’æœ‰å…¶ä»–æ‡‰ç”¨ä½”ç”¨éº¥å…‹é¢¨',
          '5. å¦‚éœ€å”åŠ©è«‹æŸ¥çœ‹æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯'
        ];
      }
      
      // é¡¯ç¤ºä¸»è¦æŒ‡å°ä¿¡æ¯
      this.showMessage(guidance, 'info');
      
      // é€æ­¥é¡¯ç¤ºè©³ç´°æ­¥é©Ÿ
      actions.forEach((action, index) => {
        setTimeout(() => {
          this.showMessage(action, 'info');
        }, (index + 1) * 1500);
      });
      
      // æœ€å¾Œé¡¯ç¤ºå¿«æ·éµæç¤º
      setTimeout(() => {
        this.showMessage('âŒ¨ï¸ å¿«æ·éµï¼šCtrl+Shift+W é–‹å•Ÿç¨ç«‹å­—å¹•è¦–çª—', 'success');
      }, (actions.length + 1) * 1500);
      
    }, 2000);
  }

  stopRecording() {
    console.log('åœæ­¢éŒ„éŸ³...');
    
    this.isRecording = false;
    
    if (this.recognition) {
      try {
        this.recognition.stop();
      } catch (error) {
        console.log('åœæ­¢èªéŸ³è­˜åˆ¥æ™‚å‡ºéŒ¯:', error.message);
      }
    }
    
    this.showMessage('ğŸ›‘ èªéŸ³è­˜åˆ¥å·²åœæ­¢', 'info');
  }

  async toggleRecording() {
    console.log('åˆ‡æ›éŒ„éŸ³ç‹€æ…‹ï¼Œç•¶å‰ç‹€æ…‹:', this.isRecording);
    
    if (this.isRecording) {
      this.stopRecording();
      return true;
    } else {
      return await this.startRecording();
    }
  }

  hideSubtitles() {
    if (this.subtitleContainer) {
      this.subtitleContainer.style.display = 'none';
    }
  }

  clearSubtitles() {
    if (this.subtitleContent) {
      const subtitleGroups = this.subtitleContent.querySelectorAll('.subtitle-group');
      subtitleGroups.forEach(group => group.remove());
      
      const interimSubtitle = this.subtitleContent.querySelector('.interim-subtitle');
      if (interimSubtitle) {
        interimSubtitle.remove();
      }
    }
  }

  createLivePanel(contentArea) {
    const livePanel = document.createElement('div');
    livePanel.className = 'subtitle-panel live-panel active';
    livePanel.innerHTML = `
      <div class="panel-header">
        <h3>ğŸ“º å³æ™‚å­—å¹•</h3>
        <div class="live-controls">
          <button class="clear-live-btn">ğŸ—‘ï¸ æ¸…é™¤</button>
        </div>
      </div>
      <div class="live-content" id="liveContent">
        <div class="no-content">é»æ“Šé–‹å§‹éŒ„éŸ³ï¼Œå³æ™‚é¡¯ç¤ºèªéŸ³è­˜åˆ¥çµæœ</div>
      </div>
    `;
    
    this.subtitlePanels.live = livePanel;
    contentArea.appendChild(livePanel);
  }

  createHistoryPanel(contentArea) {
    const historyPanel = document.createElement('div');
    historyPanel.className = 'subtitle-panel history-panel';
    historyPanel.innerHTML = `
      <div class="panel-header">
        <h3>ğŸ“š æœƒè©±è¨˜éŒ„</h3>
        <div class="history-controls">
          <button class="export-btn">ğŸ“¤ åŒ¯å‡º</button>
          <button class="clear-history-btn">ğŸ—‘ï¸ æ¸…é™¤</button>
        </div>
      </div>
      <div class="history-content" id="historyContent">
        <div class="no-content">å°šç„¡æœƒè©±è¨˜éŒ„</div>
      </div>
    `;
    
    this.subtitlePanels.history = historyPanel;
    contentArea.appendChild(historyPanel);
  }

  createTranslationPanel(contentArea) {
    const translationPanel = document.createElement('div');
    translationPanel.className = 'subtitle-panel translation-panel';
    translationPanel.innerHTML = `
      <div class="panel-header">
        <h3>ğŸŒ ç¿»è­¯çµæœ</h3>
        <div class="translation-controls">
          <select class="target-language-select" id="targetLanguageSelect">
            <option value="zh-tw">ç¹é«”ä¸­æ–‡</option>
            <option value="zh-cn">ç°¡é«”ä¸­æ–‡</option>
            <option value="en">English</option>
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="ko">í•œêµ­ì–´</option>
          </select>
          <button class="refresh-translation-btn">ğŸ”„ é‡æ–°ç¿»è­¯</button>
        </div>
      </div>
      <div class="translation-content" id="translationContent">
        <div class="no-content">ç¿»è­¯çµæœå°‡åœ¨æ­¤é¡¯ç¤º</div>
      </div>
    `;
    
    this.subtitlePanels.translation = translationPanel;
    contentArea.appendChild(translationPanel);
  }

  setupEnhancedEventListeners() {
    // è¦–åœ–åˆ‡æ›
    this.subtitleContainer.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const view = e.target.getAttribute('data-view');
        this.switchView(view);
      });
    });
    
    // æœ€å°åŒ–/é—œé–‰
    this.subtitleContainer.querySelector('.minimize-btn').addEventListener('click', () => {
      this.minimizeContainer();
    });
    
    this.subtitleContainer.querySelector('.close-btn').addEventListener('click', () => {
      this.hideSubtitles();
    });
    
    // é¢æ¿å…§æ§åˆ¶
    this.subtitleContainer.querySelector('.clear-live-btn').addEventListener('click', () => {
      this.clearLiveContent();
    });
    
    this.subtitleContainer.querySelector('.export-btn').addEventListener('click', () => {
      this.exportHistory();
    });
    
    this.subtitleContainer.querySelector('.clear-history-btn').addEventListener('click', () => {
      this.clearHistory();
    });
    
    this.subtitleContainer.querySelector('.refresh-translation-btn').addEventListener('click', () => {
      this.refreshTranslations();
    });
  }

  switchView(view) {
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    this.subtitleContainer.querySelectorAll('.view-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    this.subtitleContainer.querySelector(`[data-view="${view}"]`).classList.add('active');
    
    // åˆ‡æ›é¢æ¿é¡¯ç¤º
    Object.values(this.subtitlePanels).forEach(panel => {
      panel.classList.remove('active');
    });
    
    if (this.subtitlePanels[view]) {
      this.subtitlePanels[view].classList.add('active');
    }
    
    this.currentView = view;
  }

  minimizeContainer() {
    if (this.subtitleContainer) {
      this.subtitleContainer.style.display = 'none';
      this.subtitleContainer.style.transform = 'translate(0, 0)'; // é‡ç½®ä½ç½®
      this.subtitleContainer.style.width = 'auto'; // æ¢å¾©å¯¬åº¦
      this.subtitleContainer.style.height = 'auto'; // æ¢å¾©é«˜åº¦
      this.subtitleContainer.style.minWidth = '0'; // æœ€å°å¯¬åº¦
      this.subtitleContainer.style.minHeight = '0'; // æœ€å°é«˜åº¦
      this.subtitleContainer.style.maxWidth = 'none'; // æœ€å¤§å¯¬åº¦
      this.subtitleContainer.style.maxHeight = 'none'; // æœ€å¤§é«˜åº¦
      this.subtitleContainer.style.overflow = 'hidden'; // éš±è—æº¢å‡º
      this.subtitleContainer.style.opacity = '0'; // éš±è—
      this.subtitleContainer.style.transition = 'all 0.3s ease-in-out';
      this.subtitleContainer.style.zIndex = '1'; // ç¢ºä¿åœ¨æœ€ä¸Šå±¤
    }
  }

  maximizeContainer() {
    if (this.subtitleContainer) {
      this.subtitleContainer.style.display = 'block';
      this.subtitleContainer.style.transform = 'translate(0, 0)'; // é‡ç½®ä½ç½®
      this.subtitleContainer.style.width = '100%'; // æœ€å¤§åŒ–å¯¬åº¦
      this.subtitleContainer.style.height = '100%'; // æœ€å¤§åŒ–é«˜åº¦
      this.subtitleContainer.style.minWidth = '0'; // æœ€å°å¯¬åº¦
      this.subtitleContainer.style.minHeight = '0'; // æœ€å°é«˜åº¦
      this.subtitleContainer.style.maxWidth = 'none'; // æœ€å¤§å¯¬åº¦
      this.subtitleContainer.style.maxHeight = 'none'; // æœ€å¤§é«˜åº¦
      this.subtitleContainer.style.overflow = 'auto'; // å…è¨±æ»¾å‹•
      this.subtitleContainer.style.opacity = '1'; // é¡¯ç¤º
      this.subtitleContainer.style.transition = 'all 0.3s ease-in-out';
      this.subtitleContainer.style.zIndex = '1000'; // ç¢ºä¿åœ¨æœ€ä¸Šå±¤
    }
  }

  clearLiveContent() {
    const liveContent = document.getElementById('liveContent');
    if (liveContent) {
      liveContent.innerHTML = '<div class="no-content">å³æ™‚å­—å¹•å·²æ¸…é™¤</div>';
    }
  }

  exportHistory() {
    if (this.sessionHistory.records.length === 0) {
      alert('æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒ¯å‡º');
      return;
    }
    
    const content = this.sessionHistory.records.map(record => {
      const translations = record.translations.map(t => 
        `${this.getLanguageName(t.language)}: ${t.text}`
      ).join('\n  ');
      
      return `[${record.timestamp.toLocaleString()}] ${record.speakerInfo.speaker}\nåŸæ–‡: ${record.originalText}\nç¿»è­¯:\n  ${translations}\n---`;
    }).join('\n\n');
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `æœƒè©±è¨˜éŒ„_${this.sessionHistory.sessionId}_${new Date().toISOString().slice(0, 10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  clearHistory() {
    if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœƒè©±è¨˜éŒ„å—ï¼Ÿ')) {
      this.sessionHistory.records = [];
      this.updateHistoryPanel();
      this.updateStatusBar();
    }
  }

  refreshTranslations() {
    // é‡æ–°ç¿»è­¯æœ€è¿‘çš„å¹¾æ¢è¨˜éŒ„
    const recentRecords = this.sessionHistory.records.slice(-5);
    
    recentRecords.forEach(async (record) => {
      try {
        const response = await chrome.runtime.sendMessage({
          action: 'translate',
          text: record.originalText,
          targetLanguages: this.settings.targetLanguages || ['zh-tw', 'en']
        });
        
        if (response && response.success) {
          record.translations = response.data.translations;
          record.translationStatus = 'completed';
          
          // æ›´æ–°é¡¯ç¤º
          this.updateHistoryPanel();
          this.updateTranslationPanel(record);
        }
      } catch (error) {
        console.error('é‡æ–°ç¿»è­¯å¤±æ•—:', error);
      }
    });
  }

  updateStatusBar() {
    const recordCount = this.subtitleContainer.querySelector('.record-count');
    const sessionInfo = this.subtitleContainer.querySelector('.session-info');
    const recordingStatus = this.subtitleContainer.querySelector('.recording-status');
    
    if (recordCount) {
      recordCount.textContent = `è¨˜éŒ„ï¼š${this.sessionHistory.records.length}`;
    }
    
    if (recordingStatus) {
      recordingStatus.textContent = this.isRecording ? 'ğŸ¤ éŒ„éŸ³ä¸­' : 'â¸ï¸ å¾…æ©Ÿä¸­';
    }
  }
}

// å…¨åŸŸæ‡‰ç”¨å¯¦ä¾‹
let speechApp = null;

// ç›£è½ä¾†è‡ªpopupçš„è¨Šæ¯
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  console.log('æ”¶åˆ°è¨Šæ¯:', request);
  
  if (request.action === 'toggleRecording') {
    if (!speechApp) {
      console.log('åˆå§‹åŒ–èªéŸ³ç¿»è­¯æ‡‰ç”¨...');
      speechApp = new SpeechTranslationApp();
      
      // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
      setTimeout(async () => {
        try {
          const success = await speechApp.toggleRecording();
          sendResponse({ 
            success: true, 
            isRecording: speechApp.isRecording,
            message: success ? 'åˆ‡æ›æˆåŠŸ' : 'å•Ÿå‹•å¤±æ•—'
          });
        } catch (error) {
          sendResponse({ 
            success: false, 
            error: error.message,
            isRecording: false
          });
        }
      }, 500);
      return true;
    } else {
      speechApp.toggleRecording().then(success => {
        sendResponse({ 
          success: true, 
          isRecording: speechApp.isRecording,
          message: success ? 'åˆ‡æ›æˆåŠŸ' : 'æ“ä½œå¤±æ•—'
        });
      }).catch(error => {
        sendResponse({ 
          success: false, 
          error: error.message,
          isRecording: false
        });
      });
      return true;
    }
  }
  
  if (request.action === 'hideSubtitles') {
    if (speechApp) {
      speechApp.hideSubtitles();
    }
    sendResponse({ success: true });
  }
  
  if (request.action === 'clearSubtitles') {
    if (speechApp) {
      speechApp.clearSubtitles();
    }
    sendResponse({ success: true });
  }
  
  if (request.action === 'updateSettings') {
    if (speechApp) {
      speechApp.settings = { ...speechApp.settings, ...request.settings };
      console.log('ğŸ“¨ content.jsæ”¶åˆ°è¨­å®šæ›´æ–°:', request.settings);
    }
    sendResponse({ success: true });
  }

  if (request.action === 'settingsUpdated') {
    console.log('ğŸ“¨ content.jsæ”¶åˆ°è¨­å®šæ›´æ–°é€šçŸ¥:', request.settings);
    // é‡æ–°è¼‰å…¥è¨­å®š
    if (speechApp) {
      speechApp.loadSettings();
    }
    sendResponse({ success: true });
  }
  
  if (request.action === 'checkStatus') {
    sendResponse({ 
      success: true, 
      isRecording: speechApp ? speechApp.isRecording : false,
      hasRecognition: speechApp ? !!speechApp.recognition : false
    });
  }
});

// é é¢è¼‰å…¥å®Œæˆå¾Œæº–å‚™åˆå§‹åŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    console.log('é é¢è¼‰å…¥å®Œæˆï¼Œæº–å‚™èªéŸ³ç¿»è­¯åŠŸèƒ½');
  });
} else {
  console.log('é é¢å·²è¼‰å…¥ï¼Œæº–å‚™èªéŸ³ç¿»è­¯åŠŸèƒ½');
}